# Сравнение инструментов для реализации клиент-серверного взаимодействия

## Введение

Веб-серивисы являются одной из самых больших областей в разработке как по количеству проектов, так и по количеству привлеченных пользователей. Для подобных систем важной метрикой является количество запросов или пользователей, которые они могут обработать. А значит актуальным вопросов является изучение и повышение пропускной способности. Достичь этого можно разными способами, одним из которых является горизонтальное масштабирование - увеличение производительности приложения за счет добавления новых вычислительных узлов и распределения нагрузки между ними. Данный способ является эффетивным, но требует усложнения инфраструктуры. Может случиться ситуация, когда низкая производительность связана с выбором инструментов для реализации взаимодействия. Чтобы доказать или опровергнуть это предположение требуется анализ доступных и подходящих решений.

## Описание архитектуры клиент-серверных систем

В рамках дальнейшего рассмотрения будем под клиент-сервреной системой подразумевать такую архитектуру, где есть главный сервер, который обрабатывает информацию и большое количество клиентов, которые к серверу подключаются, отправляют запросы. В рамках работы будут рассматриваться технологии реализации клиент-серверного общения с использованием .NET стека, в часности языка C#.

## Windows Communication Foundation

 Windows Communication Foundation (WCF) – это унифицированная модель программирования распределенных приложений на платформе Microsoft.

Технология Windows Communication Foundation (WCF) – это службы, их создание, размещение, потребление и обеспечение безопасности, средства организации распределенных вычислений.  В основе своей служба – это множество оконечных точек (endpoints), которые предоставляет клиентам некие полезные возможности. Оконечная точка – это сетевой ресурс, которому можно посылать сообщения. 

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/c1e6d512-ac7e-43ed-92e1-fdbc5558c516/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/c1e6d512-ac7e-43ed-92e1-fdbc5558c516/Untitled.png)

Для передачи информации клиент должен знать:

- Адресс. Адресс определяет, куда следует отправить сообщение, чтобы оконечная точка их получила. Это может быть HTTP или TCP.
- Привязку. Привяка определяет канал для коммуникации с оконечной точкойКанал состоит из нескольких элементов привязки (binding element). На самом нижнем уровне элемент привязки – это транспортный механизм, обеспечивающий доставку сообщений по сети. В WCF встроены следующие транспорты: HTTP, TCP, Named Pipes, PerChannel и MSMQ.
- Контракт. Контракт определяет набор функций, которые предоставляются оконечной точкой - операции, которые она выполняет, форматы сообщений для этих операций. Описанные в контракте операции отображаются на методы класса, реализующего оконечную точку, и включают в частности типы параметров, передаваемых каждому методу и получаемых от него

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/1a478808-fb4b-4343-82df-e9c0878520a5/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/1a478808-fb4b-4343-82df-e9c0878520a5/Untitled.png)

Для передачи данный используется xml-сериализация, а также кодирование. Кодирование в контексте WCF называется процесс преобразования данных в массив байтов.

Безопасность на уровне транспорта обеспечивает защиту отправляемых данных безотносительно к их содержимому. Обычно для этой цели применяют протокол Secure Sockets Layer (SSL), с помощью которого шифруются и подписываются пакеты, передаваемые по протоколу HTTPS. Существуют и другие механизмы защиты на транспортном уровне, выбор того или другого зависит от привязки WCF.

## gRPC

gRpc - фреймворк для удаленного вызова процедур (RPC). Как и другие RPC системы, идея данного подхода заключается в предоставлении возможности вызывать методы на сервере со стороны клиента: сервер предоставляет интерфейс(набор методов), которые могут быть вызваны, а клиент имеет логику, котора проксирует вызовы на этот сервер.

В основе протоколов gRPC лежит Protocol buffer - специальный механизм для сериализации структурированный данных. Данный протокол позволяет уменьшить накладные расходы на передаваеммые данные - данные сериализованные с использованием protobuf занимают меньше памяти нежели аналогичные сериализованные данные в xml.

 

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/354aa6b7-f4bc-4ef7-abfc-4936554ac41c/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/354aa6b7-f4bc-4ef7-abfc-4936554ac41c/Untitled.png)

Помимо простой системы request-response, в gRPC поддерживается возможность независимого обмена сообщениями в обе стороны. Также, фреймворком поддерживается авторизация с использованием SSL, шифрование. 

## ASP Web API

ASP Web API - часть фремворка ASP.NET, которая предоставляет инструменты для создания REST-сервисов. Web API отличается от WCF также и способом хостинга: wcf обычно использует IIS (Internet Information Services), а Web API хоть и поддерживает IIS, но по-умолчанию использует Kestel web server. Вариативность в таких вещах увеличивает количество аспектов, которые нужно рассамотреть: разные веб серверы могут быть или не быть кросплатформенными, могут иметь ограничения на использование, различный набор встроенных инструментов и влиять на скорость обработки запросов.

## Сравнение подходов

Для вравнения различных подходов требуется реализовать одинаковый тест скорости работы. В случае библиотек для клиент-серверного взаимодейтвия, в качестве теста может быть использован стенд, где будут поднят сервер, клиент, между ними будут лететь запросы. Метрикой в таком случае будет количество запросов, которые удается обработать в секунду. Результаты одного из таких тестов является тест различных реализаций gRPC. 

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/06ef0a42-65cd-4c40-979e-c1250bddf3ae/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/06ef0a42-65cd-4c40-979e-c1250bddf3ae/Untitled.png)

Стоит также учитывать особенности среды выполнения. Различные реализации могут давать разные результаты при выполнении на разном количестве потоков выполнения. Это зависит от накладных расходов на паралелизм в системе. На тех же условиях теста и тех же реализациях библиотек, используя только один поток выполнеия, результат получается другой.

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/61c83034-a469-49ab-be3d-f12722e38b51/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/61c83034-a469-49ab-be3d-f12722e38b51/Untitled.png)

В случае сравнений разных библиотек появляются проблемы - у них отличается окружение, это может сильно повлиять на производительнось. Например, в случае WCF, для тестов требуется поднять службу исполльзуя IIS, в случае ASP Web API используется другая система хостинга.

Для сравнения производительности кода на C# самым популярным инструментом является BenchmarkDotNet. Он позволяет гибко настраивать тест-кейсы, считать погрешности и прочее. Ниже приведены результаты бенчмарка выполнения запросов к gRPC и REST (ASP Web Api). В тесте выполнялись GET и POST запросы, они прокидывали заранее сгенериролванные данные. Можно отметить, что  во всех случаях gRPC показывает результат лучше - около 120 миллисекунд на POST-запрос против 689 милисекунд у REST, в том числе на аллокациях памяти.

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/f3f1e330-5d2c-45de-b266-ccfde3f23091/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/f3f1e330-5d2c-45de-b266-ccfde3f23091/Untitled.png)

Важно понимать, что такие технологии как gRPC активно поддерживаются и развиваются в отличии от .NET Remoting'а или WCF. Это нужно учитывать в тестах. Некоторые использованные источники тестировали работу используся .NET Core 3, который вышел два года назад. Компания Microsoft проводила ряд тестов производительности на которых заметно повышение производительности как общих вещей (GC, JIT), так и инструментов связанных с передачей данных - методы сокетов, методы http, SSL-потоки. Повышения отдельных моментов достигают 25%, что может сильно скзааться на тестах. Запустив те же тесты на .NET Core 3 можно получить результат на 20% хуже в случае gRPC и в несколько раз хуже для Web API.

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/6159aeb4-52cc-42ea-a873-b37446051b2d/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/6159aeb4-52cc-42ea-a873-b37446051b2d/Untitled.png)

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/0dec0534-1975-43a8-b9aa-63d56632e117/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/0dec0534-1975-43a8-b9aa-63d56632e117/Untitled.png)

## Заключение

Были расмотрены основные инструменты для создания клиент-серверного взаимодействия, выделены аспекты, которые могут влиять на их производительность:

- Особенности протокола - xml, json и protobuf имеют разный процент полезной нагрузки в сообщении
- веб сервер, который используется для развертывания приложения
- версия среды выполнения
- особенности железа, на котором происходит выполнение (количество ядер, которые используются)

Дальнешее расмотрение темы может заключатся в более детальном разборе факторов, проверки влияния комбинаторики, добавления новых факторов (размеры и однотипность сообщений, количество параллельных подключений). 

## Список литературы

1. Стив Резник, Ричард Крейн, Крис Боуэн. Основы Windows Communication Foundation для .NET Framework 3.5: Пер. с англ. Слинкина А. А. – М.: ДМК Пресс, 2008. – 480 с.
2. gRPC. Core concepts, architecture and lifecycle [Электронный ресурс] – 2021. – Режим доступа: [https://grpc.io/docs/what-is-grpc/core-concepts/](https://grpc.io/docs/what-is-grpc/core-concepts/)
3. Cloud-native communication patterns. gRPC [Электронный ресурс] – 2021. – Режим доступа: [https://docs.microsoft.com/en-us/dotnet/architecture/cloud-native/grpc](https://docs.microsoft.com/en-us/dotnet/architecture/cloud-native/grpc)
4. Introduction to [ASP.NET](http://asp.net/) Core [Электронный ресурс] – 2020 – Режим доступа: [https://docs.microsoft.com/en-us/aspnet/core/web-api/](https://docs.microsoft.com/en-us/aspnet/core/web-api/)
5. Comparing Performance of gRPC, Web API and WCF Services [Электронный ресурс] – 2020. – Режим доступа: [https://developingdane.com/service-compare/](https://developingdane.com/service-compare/)
6. Evaluating Performance of REST vs. gRPC [Электронный ресурс] – 2019. – Режим доступа: [https://medium.com/@EmperorRXF/evaluating-performance-of-rest-vs-grpc-1b8bdf0b22da](https://medium.com/@EmperorRXF/evaluating-performance-of-rest-vs-grpc-1b8bdf0b22da)
7. gRPC benchmark [Электронный ресурс] – 2021. – Режим доступа: [https://github.com/LesnyRumcajs/grpc_bench](https://github.com/LesnyRumcajs/grpc_bench)
8. Performance Improvements in .NET 5 [Электронный ресурс] – 2020. – Режим доступа: [https://devblogs.microsoft.com/dotnet/performance-improvements-in-net-5/](https://devblogs.microsoft.com/dotnet/performance-improvements-in-net-5/)